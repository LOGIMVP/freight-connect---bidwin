import { useState, useCallback, useMemo } from 'react';
import { Truck, MapPin, Calendar, Scale, Ruler, FileText, Upload, Trash2, Save, X } from 'lucide-react';

// Mock Data Interfaces (Should ideally be imported from types.ts)
interface Document {
  id: string;
  name: string;
  url: string;
  type: 'shipper' | 'carrier';
}

interface Shipment {
  loadId: string;
trackingLink: string;
  pickup: { location: string; contact: string; phone: string; stops: number };
  delivery: { location: string; contact: string; email: string; phone: string; stops: number };
  specs: { equipment: string; equipmentDetail: string; totalWeight: string; totalSkidQuantity: number; estLinearFeet: string };
  scheduling: { pickupDeadline: string; dropOffDeadline: string };
  skids: { quantity: number; dimensions: string; weight: number }[];
  shipperDocuments: Document[];
  awardedRate: number;
  notes: string;
}

// Mock initial data (for demonstration)
const MOCK_SHIPMENT: Shipment = {
  loadId: "L-4839",
  trackingLink: "https://cloud.samsara.com/load-details/L-4839", 
  pickup: { location: "123 Oilfield Way, Edmonton, AB", contact: "Edmonton Supply", phone: "780-555-0500", stops: 1 },
  delivery: { location: "789 Central Goods Rd, Winnipeg, MB", contact: "Central Logistics", email: "wpg.logistics@example.com", phone: "204-555-0700", stops: 1 },
  specs: { equipment: "LTL", equipmentDetail: "(Dry Van)", totalWeight: "9,000 lbs", totalSkidQuantity: 9, estLinearFeet: "12.5 ft" },
  scheduling: { pickupDeadline: "Nov 18, 2025", dropOffDeadline: "Nov 21, 2025" },
  skids: [{ quantity: 9, dimensions: "40 x 40 x 40", weight: 1000 }],
  shipperDocuments: [
    { id: 'S-1', name: "Bill_of_Lading_123.pdf", url: "#", type: 'shipper' },
    { id: 'S-2', name: "Pickup_Ref_54321.pdf", url: "#", type: 'shipper' },
  ],
  awardedRate: 1100.00,
  notes: "Pickup by appointment only. Driver must check in 30 mins prior to arrival.",
};

// --- Component Helper: DocumentRow ---
const DocumentRow: React.FC<{ doc: Document; onRemove?: (id: string) => void }> = ({ doc, onRemove }) => (
  <div className="flex items-center justify-between text-sm ml-7 p-2 bg-gray-50 rounded-lg">
    <div className="flex items-center space-x-2 w-2/3 truncate">
        <FileText className="w-4 h-4 text-primary-blue flex-shrink-0" />
        <span className="truncate pr-2 font-medium text-gray-700">{doc.name}</span>
    </div>
    <div className="flex space-x-2">
        {/* View Button */}
        <a href={doc.url} target="_blank" rel="noopener noreferrer" className="px-3 py-1 text-xs text-primary-blue border border-primary-blue rounded-full hover:bg-blue-50 transition duration-150">
            View
        </a>
        
        {/* Remove Button (Only for Carrier Documents) */}
        {doc.type === 'carrier' && onRemove && (
            <button
                className="flex items-center px-3 py-1 text-xs text-white bg-primary-red rounded-full hover:bg-red-600 transition duration-150 shadow-sm"
                onClick={() => onRemove(doc.id)}
            >
                <Trash2 className="w-3 h-3 mr-1" />
                Remove
            </button>
        )}
    </div>
  </div>
);


// --- Main Component ---
const CarrierDetailView: React.FC = () => {
  const [trackingLink, setTrackingLink] = useState(MOCK_SHIPMENT.trackingLink);
  // Separate state for documents the carrier has added (or modified/removed locally)
  const [carrierDocuments, setCarrierDocuments] = useState<Document[]>([]);
  // Store the initial tracking link value to check for changes
  const initialTrackingLink = MOCK_SHIPMENT.trackingLink;
  
  // Custom message state for toast notifications
  const [message, setMessage] = useState<{ text: string; color: string } | null>(null);

  // Function to show a temporary message (Toast)
  const showMessage = useCallback((text: string, color: string) => {
    setMessage({ text, color });
    setTimeout(() => setMessage(null), 5000); // Clear after 5 seconds
  }, []);

  // Use useMemo to check if there are any pending changes
  const hasUnsavedChanges = useMemo(() => {
    const linkChanged = trackingLink !== initialTrackingLink;
    const documentsAddedOrRemoved = carrierDocuments.length > 0; // Simple check for pending docs
    // In a real app, you'd check for new, deleted, and modified docs against a "saved" list
    return linkChanged || documentsAddedOrRemoved;
  }, [trackingLink, initialTrackingLink, carrierDocuments.length]);

  // --- HANDLERS ---

  const handleTrackingLinkChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    setTrackingLink(e.target.value);
  }, []);

  const handleFileUpload = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 10 * 1024 * 1024) {
        showMessage(`File size exceeds 10MB limit: ${file.name}`, "bg-primary-red");
        return;
      }

      showMessage(`Uploading file: ${file.name} (simulated)...`, "bg-primary-blue");

      // Simulate a successful upload after a short delay
      setTimeout(() => {
        const newDoc: Document = {
          id: `carrier-doc-${Date.now()}-${Math.floor(Math.random() * 1000)}`,
          name: file.name,
          url: '#', // Placeholder URL
          type: 'carrier',
        };
        
        // --- KEY FIX: Update the state with the new document ---
        setCarrierDocuments(prevDocs => [...prevDocs, newDoc]);
        
        // Clear the file input for re-uploading the same file
        e.target.value = ''; 
        
        showMessage(`Document added. Click 'Update Changes' to save.`, "bg-accent-yellow text-gray-800");

      }, 1500);
    }
  }, [showMessage]);

  // --- ATTACHMENT REMOVAL FIX IS HERE ---
  const handleRemoveAttachment = useCallback((docId: string) => {
    // This is the CRITICAL STEP: Filter the documents list and update the state.
    setCarrierDocuments(prevDocs => {
        const updatedDocs = prevDocs.filter(doc => doc.id !== docId);
        return updatedDocs;
    });

    showMessage(`Document removed locally. Click 'Update Changes' to finalize.`, "bg-accent-yellow text-gray-800");
  }, [showMessage]);
  // --- END OF ATTACHMENT REMOVAL FIX ---

  const handleSaveChanges = useCallback(() => {
    // 1. Send trackingLink update to the API
    // 2. Send carrierDocuments list (additions/deletions) to the API
    
    showMessage("Saving all updates to tracking link and documents...", "bg-update-purple");

    // Simulate save success
    setTimeout(() => {
        // In a real app, the server would return the new list of saved documents.
        // For this mock, we assume success and clear the temporary state:
        // A complete save would involve integrating these documents into the main shipment state
        // and resetting the trackingLink state back to the 'initial' value.
        // For simplicity, we just show a success message:
        
        // This is where you would update MOCK_SHIPMENT.trackingLink = trackingLink
        // And MOCK_SHIPMENT.carrierDocuments = savedDocuments

        showMessage("Shipment details updated successfully.", "bg-primary-green");
    }, 1500);
  }, [trackingLink, carrierDocuments, showMessage]);


  // Helper component for layout
  const DetailCard: React.FC<{ title: string; children: React.ReactNode; className?: string }> = ({ title, children, className = '' }) => (
    <div className={`info-card p-6 ${className}`}>
      <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
        {title === 'Shipment Specifications' && <Scale className="w-5 h-5 mr-2 text-primary-blue" />}
        {title === 'Scheduling' && <Calendar className="w-5 h-5 mr-2 text-primary-red" />}
        {title === 'Attachments' && <FileText className="w-5 h-5 mr-2 text-gray-500" />}
        {title === 'Special Notes' && <Truck className="w-5 h-5 mr-2 text-yellow-700" />}
        {title}
      </h2>
      {children}
    </div>
  );
  
  // Combine all documents for display
  const allDocuments = useMemo(() => [
      ...MOCK_SHIPMENT.shipperDocuments,
      ...carrierDocuments,
  ], [carrierDocuments]);


  return (
    <div className="p-4 md:p-8 max-w-7xl mx-auto space-y-6">
      
      {/* HEADER ROW: TITLE AND LIVE TRACKING INPUT */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-gray-200 pb-3">
        <h1 className="text-2xl font-bold text-gray-800">Shipment Details ({MOCK_SHIPMENT.loadId})</h1>
        
        {/* TRACKING LINK INPUT FIELD */}
        <div className="flex flex-col md:flex-row items-start md:items-center text-sm mt-2 md:mt-0">
            <label htmlFor="tracking-link" className="font-semibold text-gray-700 mr-2 whitespace-nowrap">Tracking Link:</label>
            <input 
                type="url" 
                id="tracking-link" 
                value={trackingLink} 
                onChange={handleTrackingLinkChange}
                placeholder="Paste your live tracking URL here"
                className="w-full md:w-80 p-2 border border-gray-300 rounded-md text-text-blue focus:ring-primary-blue focus:border-primary-blue text-sm truncate transition duration-150"
            />
        </div>
      </div>

      {/* UNSAVED CHANGES BANNER CONTAINER */}
      {hasUnsavedChanges && (
        <div className="flex flex-col md:flex-row justify-between items-center unsaved-box p-4 rounded-xl shadow-lg border-2 border-accent-yellow transition duration-300">
            <p className="text-lg font-bold text-gray-800 mb-3 md:mb-0 flex items-center">
                <X className="w-6 h-6 mr-2 text-primary-red" />
                You have unsaved changes.
            </p>
            <button 
                className="flex-1 md:flex-none px-6 py-2 text-sm font-semibold text-white bg-update-purple rounded-full hover:bg-indigo-600 transition shadow-lg" 
                onClick={handleSaveChanges}
            >
                <Save className="w-4 h-4 mr-2" />
                Update Changes
            </button>
        </div>
      )}


      {/* PICKUP AND DELIVERY STOPS (Top Card Row) */}
      <div className="info-card p-6">
          <div className="grid md:grid-cols-2 gap-y-6 md:gap-x-12 text-sm">
              
              {/* Pickup Stop */}
              <div className="relative pb-2 md:pr-6 border-b border-gray-200 md:border-b-0">
                  <p className="text-lg font-bold text-gray-700 mb-2 flex items-center"><MapPin className="w-5 h-5 mr-2 text-primary-green" /> Pickup Stops ({MOCK_SHIPMENT.pickup.stops}):</p>
                  <p className="text-gray-700 font-normal">{MOCK_SHIPMENT.pickup.location}</p>
                  <p className="text-gray-500">Contact: {MOCK_SHIPMENT.pickup.contact}</p>
                  <a href={`tel:${MOCK_SHIPMENT.pickup.phone.replace(/-/g, '')}`} className="absolute top-0 right-0 text-text-blue hover:underline font-semibold">{MOCK_SHIPMENT.pickup.phone}</a>
              </div>

              {/* Delivery Stop */}
              <div className="relative pb-2 md:pl-6">
                  <p className="text-lg font-bold text-gray-700 mb-2 flex items-center"><MapPin className="w-5 h-5 mr-2 text-primary-red" /> Delivery Stops ({MOCK_SHIPMENT.delivery.stops}):</p>
                  <p className="text-gray-700 font-normal">{MOCK_SHIPMENT.delivery.location}</p>
                  <p className="text-gray-500">Contact: {MOCK_SHIPMENT.delivery.contact}</p>
                  <p className="text-gray-500">Email: {MOCK_SHIPMENT.delivery.email}</p>
                  <a href={`tel:${MOCK_SHIPMENT.delivery.phone.replace(/-/g, '')}`} className="absolute top-0 right-0 text-text-blue hover:underline font-semibold">{MOCK_SHIPMENT.delivery.phone}</a>
              </div>
          </div>
      </div>


      {/* SPECIFICATIONS, SCHEDULING, SKID DETAILS, ATTACHMENTS (Main 2x2 Grid) */}
      <div className="grid lg:grid-cols-2 gap-6">

        {/* LEFT COLUMN GROUP */}
        <div className="space-y-6">
            
            {/* Shipment Specs */}
            <DetailCard title="Shipment Specifications">
                <div className="grid grid-cols-2 gap-3 text-sm">
                    {/* Row 1 */}
                    <p className="font-normal text-gray-500">Equipment</p>
                    <p className="text-right font-bold text-gray-800 text-lg">{MOCK_SHIPMENT.specs.equipment} <span className="font-normal text-gray-500 text-sm">{MOCK_SHIPMENT.specs.equipmentDetail}</span></p>

                    {/* Row 2 */}
                    <p className="font-normal text-gray-500">Total Weight</p>
                    <p className="text-right font-bold text-gray-800 text-lg">{MOCK_SHIPMENT.specs.totalWeight}</p>

                    {/* Row 3 */}
                    <p className="font-normal text-gray-500">Total Skid Quantity</p>
                    <p className="text-right font-bold text-gray-800 text-lg">{MOCK_SHIPMENT.specs.totalSkidQuantity}</p>

                    {/* Row 4 */}
                    <p className="font-normal text-gray-500">Est. Linear Feet</p>
                    <p className="text-right font-bold text-gray-800 text-lg">{MOCK_SHIPMENT.specs.estLinearFeet}</p>
                </div>
            </DetailCard>
            
            {/* Skid Details */}
            <DetailCard title="Skid Details">
                <table className="w-full text-sm text-gray-700">
                    <thead className="text-xs text-gray-600 uppercase bg-gray-50 rounded-t-lg">
                        <tr>
                            <th scope="col" className="py-3 pl-3 text-left rounded-tl-lg">Quantity</th>
                            <th scope="col" className="py-3 text-center">Dimensions (L×W×H)</th>
                            <th scope="col" className="py-3 pr-3 text-right rounded-tr-lg">Weight Per Skid (LBS)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {MOCK_SHIPMENT.skids.map((skid, index) => (
                            <tr key={index} className="bg-white border-b last:border-b-0">
                                <td className="py-4 pl-3 font-semibold text-gray-800 text-left">{skid.quantity}</td>
                                <td className="py-4 font-semibold text-gray-800 text-center">{skid.dimensions}</td>
                                <td className="py-4 pr-3 font-semibold text-gray-800 text-right">{skid.weight.toLocaleString()}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </DetailCard>
        </div>

        {/* RIGHT COLUMN GROUP */}
        <div className="space-y-6">
            
            {/* Scheduling */}
            <DetailCard title="Scheduling">
                <div className="space-y-4 text-sm">
                    <div className="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                        <p className="font-normal text-gray-500 flex items-center"><Calendar className="w-4 h-4 mr-2" /> Pickup Deadline</p>
                        <p className="text-text-red font-bold text-lg">{MOCK_SHIPMENT.scheduling.pickupDeadline}</p>
                    </div>
                    <div className="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                        <p className="font-normal text-gray-500 flex items-center"><Calendar className="w-4 h-4 mr-2" /> Drop Off Deadline</p>
                        <p className="text-text-red font-bold text-lg">{MOCK_SHIPMENT.scheduling.dropOffDeadline}</p>
                    </div>
                </div>
            </DetailCard>

            {/* Attachments */}
            <DetailCard title="Attachments">
                <div className="space-y-4">
                    {/* Shipper Documents */}
                    <p className="font-bold text-gray-700">Shipper Documents:</p>
                    <div className="space-y-2">
                        {MOCK_SHIPMENT.shipperDocuments.map(doc => (
                            <DocumentRow key={doc.id} doc={doc} />
                        ))}
                    </div>

                    {/* Carrier Documents */}
                    <p className="font-bold text-gray-700 pt-4">Your Documents:</p>
                    <div className="space-y-2" id="carrier-document-list">
                        {carrierDocuments.map(doc => (
                            // Only carrier docs get the onRemove prop
                            <DocumentRow key={doc.id} doc={doc} onRemove={handleRemoveAttachment} />
                        ))}
                    </div>

                    {/* File Upload/Drop Zone */}
                    <input 
                        type="file" 
                        id="carrier-file-upload" 
                        className="hidden" 
                        onChange={handleFileUpload}
                        // Added accept attribute for better UX
                        accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                    />
                    <div 
                        className="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:bg-blue-50 transition mt-4 shadow-inner"
                        onClick={() => document.getElementById('carrier-file-upload')?.click()}
                    >
                        <div className='flex items-center justify-center text-primary-blue font-semibold'>
                            <Upload className="w-5 h-5 mr-2" />
                            Click to upload or drag and drop (Max 10MB)
                        </div>
                    </div>
                </div>
            </DetailCard>
        </div>
      </div>


      {/* SPECIAL NOTES (Full Width) */}
      <DetailCard title="Special Notes" className="bg-accent-yellow border border-yellow-300">
        <p className="text-sm text-gray-700">{MOCK_SHIPMENT.notes}</p>
      </DetailCard>
      

      {/* CONFIRMED BANNER / ACTIONS (Full Width) */}
      <div className="flex flex-col md:flex-row justify-between items-center confirmed-box p-4 rounded-xl shadow-lg mt-6 border-2 border-primary-green">
          <p className="text-lg font-bold text-primary-green mb-3 md:mb-0 flex items-center">
              <Truck className="w-6 h-6 mr-2" />
              You won this bid! Rate: <span className="text-2xl font-extrabold ml-2">$ {MOCK_SHIPMENT.awardedRate.toLocaleString()}</span>
          </p>
          <div className="flex space-x-3 w-full md:w-auto justify-end">
              <button className="flex-1 md:flex-none px-4 py-2 text-sm font-semibold text-text-red border border-text-red bg-white rounded-full hover:bg-red-50 transition shadow-sm">
                  Cancel Shipment
              </button>
              <button className="flex-1 md:flex-none px-4 py-2 text-sm font-semibold text-white bg-primary-green rounded-full hover:bg-green-600 transition shadow-lg">
                  Mark as Delivered
              </button>
          </div>
      </div>
      
      {/* Message Box for Toasts */}
      {message && (
        <div className={`fixed bottom-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white ${message.color} transition-opacity duration-300 ease-out animate-pulse`}>
            {message.text}
        </div>
      )}

    </div>
  );
};

export default CarrierDetailView;

// Custom colors and utility classes used in Tailwind setup:
/*
.info-card { background-color: white; border-radius: 8px; box-shadow: ...; border: 1px solid #e5e7eb; }
.confirmed-box { background-color: #d1fae5; border: 2px solid #34d399; }
.unsaved-box { background-color: #fefcbf; border: 2px solid #facc15; }
.text-primary-blue: #3b82f6
.text-primary-green: #34d399
.text-primary-red: #ef4444
.bg-update-purple: #5c63ec
.bg-accent-yellow: #fef3c7
*/
